<div class="modal-header border-0 pb-0">
    <h5 class="modal-title fw-bold">Importazione Massiva Studenti</h5>
    <button type="button" class="btn-close shadow-none" (click)="activeModal.dismiss()"></button>
</div>

<div class="modal-body p-4">
    <div class="mb-4">
        <label class="form-label small fw-bold text-muted d-flex justify-content-between align-items-center">
            Incolla i dati
            <button class="btn btn-link p-0 text-primary fs-xs text-decoration-none" (click)="showHelp = !showHelp">
                {{ showHelp ? 'Chiudi aiuto' : 'Aiuto formato' }}
            </button>
        </label>

        @if (showHelp) {
            <div class="bg-light border rounded-3 p-3 mb-3 small shadow-sm animate-in">
                <p class="fw-bold text-dark mb-2">Formato richiesto:</p>
                <div class="bg-white p-2 rounded border extra-small font-monospace mb-2 text-muted">
                    Nome, Cognome, Email
                </div>
                <p class="extra-small text-muted mb-0">Esempio: Marco, Rossi, marco@example.com</p>
            </div>
        }

        <textarea class="form-control border-light shadow-none small" rows="5" 
            [(ngModel)]="importData" (input)="parseData()"
            placeholder="Marco, Rossi, marco@example.com&#10;Anna, Bianchi, anna@example.com"></textarea>
        
        <p class="extra-small text-muted mt-2 italic">
            <fa-icon [icon]="icons.faCheckCircle" class="me-1 text-success"></fa-icon>
            Gli utenti già esistenti verranno associati alla classe senza duplicazioni.
        </p>
    </div>

    <!-- Pick Existing Students -->
    <div class="mb-4">
        <button class="btn btn-light btn-sm w-100 border text-muted small py-2 d-flex align-items-center justify-content-center gap-2" (click)="toggleExisting()">
            <fa-icon [icon]="icons.faUsers"></fa-icon>
            {{ showExisting ? 'Nascondi studenti esistenti' : 'Seleziona studenti già registrati' }}
        </button>

        @if (showExisting) {
            <div class="mt-3 animate-in">
                <input type="text" class="form-control form-control-sm mb-3" placeholder="Cerca studente..." [(ngModel)]="searchQuery">
                <div class="list-group list-group-flush border rounded-3 overflow-auto" style="max-height: 200px;">
                    @for (std of filteredStudents; track std._id) {
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-2 cursor-pointer" (click)="toggleStudentSelection(std._id)">
                            <div class="small">
                                <div class="fw-bold">{{ std.firstName }} {{ std.lastName }}</div>
                                <div class="text-muted extra-small">{{ std.email }}</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" [checked]="selectedExistingIds.has(std._id)">
                            </div>
                        </div>
                    } @empty {
                        <div class="p-3 text-center text-muted extra-small">Nessuno studente trovato</div>
                    }
                </div>
            </div>
        }
    </div>

    @if (parsedStudents.length > 0 || selectedExistingIds.size > 0) {
        <div class="p-3 bg-light border border-light rounded-3 mb-4 animate-in">
            <p class="small fw-bold mb-2">Riepilogo:</p>
            <ul class="list-unstyled mb-0 extra-small text-muted">
                @if (parsedStudents.length > 0) {
                    <li>• {{ parsedStudents.length }} studenti da importare/associare tramite testo</li>
                }
                @if (selectedExistingIds.size > 0) {
                    <li>• {{ selectedExistingIds.size }} studenti selezionati dall'elenco</li>
                }
            </ul>
        </div>
    }

    <div class="row g-3 mb-4">
        <div class="col-md-7">
            <label class="form-label small fw-bold text-muted">Classe di destinazione</label>
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-light border-light pe-2">
                    <fa-icon [icon]="icons.faUsers" class="extra-small text-muted"></fa-icon>
                </span>
                <select class="form-select border-light py-2" [(ngModel)]="selectedClassId">
                    <option value="">Seleziona classe...</option>
                    @for (cls of classes; track cls._id) {
                        <option [value]="cls._id">{{ cls.name }}</option>
                    }
                </select>
            </div>
        </div>
        <div class="col-md-5 d-flex align-items-end">
            <div class="bg-light p-2 rounded-3 w-100 text-center border">
                <span class="small text-muted">Totale pronti:</span>
                <div class="fw-bold text-dark">{{ parsedStudents.length + selectedExistingIds.size }}</div>
            </div>
        </div>
    </div>

    <div class="mt-4 d-grid">
        <button class="btn btn-primary fw-bold py-2 d-flex align-items-center justify-content-center gap-2" 
            [disabled]="(parsedStudents.length === 0 && selectedExistingIds.size === 0) || !selectedClassId || loading" (click)="onSubmit()">
            @if (loading) {
                <span class="spinner-border spinner-border-sm" role="status"></span>
            } @else {
                <fa-icon [icon]="icons.faFileImport"></fa-icon>
            }
            Esegui Operazione
        </button>
    </div>
</div>
