<app-back-to
  [path]="'/t/questions'"
  [label]="'Torna alla lista delle domande'"
></app-back-to>

<form
  [formGroup]="questionForm"
  (ngSubmit)="onSaveQuestion()"
  class="d-flex flex-column gap-4"
>
  <section>
    <h1 class="text-dark fw-bold mb-0 display-6">
      {{ questionId ? 'Modifica domanda' : 'Crea nuova domanda' }}
    </h1>
    <p class="text-dark">
      @if(questionId) { Modifica i dettagli della domanda selezionata. } @else {
      Compila il modulo sottostante per creare una nuova domanda. }
    </p>
  </section>

  <section class="form-section">
    <label class="form-label fw-semibold text-dark"
      >Tipologia di risposta</label
    >
    <app-type-selector
      [options]="questionTypeOptions"
      [(selectedValue)]="selectedQuestionType"
      (typeSelected)="onSelectQuestionType($event)"
      [direction]="'row'"
    ></app-type-selector>
  </section>

  <section class="form-section">
    <label class="form-label fw-semibold text-dark">Argomento</label>
    <select
      class="form-select form-select-lg custom-input w-auto"
      formControlName="topicId"
      aria-label="Seleziona argomento"
    >
      <option value="" disabled selected>Seleziona argomento</option>
      @for(topic of materiaService.topics; track topic) {
      <option [value]="topic._id">{{ topic.name }}</option>
      }
    </select>
  </section>

  <section class="form-section">
    <div
      class="d-flex flex-row justify-content-between align-items-center mb-3"
    >
      <div>
        <h5 class="form-label fw-semibold text-dark">
          Contenuto della domanda
        </h5>
        <p class="text-dark mb-0">
          Scrivi la domanda, le risposte e una spiegazione riguardante la
          risposta corretta. Puoi sempre usare l’AI per aiutarti nella
          generazione.
        </p>
      </div>
      <button
        class="btn btn-lg ai"
        type="button"
        (click)="onRequestAIGeneration()"
      >
        <fa-icon [icon]="SparklesIcon" class="me-2"></fa-icon>
        Genera con AI
      </button>
    </div>

    <section class="row">
      <div class="col-md-8 d-flex flex-column">
        <label class="form-label fw-semibold text-dark">Testo</label>
        <textarea
          class="form-control custom-input flex-fill"
          formControlName="text"
          rows="4"
          placeholder="Inserisci il testo della domanda qui..."
        ></textarea>
      </div>
      <div class="col-md-4 d-flex flex-column">
        <label class="form-label fw-semibold text-dark">Allega immagine</label>
        <div
          id="imageDropArea"
          class="rounded-4 p-3"
          [class.dragging]="isDragging()"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
          (click)="fileInput?.click()"
        >
          @if(!imagePreview()) {
          <div
            class="image-drop-zone d-flex flex-column justify-content-center align-items-center rounded-3 p-3"
          >
            <fa-icon [icon]="ImageIcon" class="mb-3" size="3x"></fa-icon>
            <p class="text-muted mb-0 text-center">
              Trascina qui un'immagine o clicca per caricare
            </p>
          </div>
          } @else {
          <div class="image-preview-container position-relative">
            <img
              [src]="imagePreview()"
              alt="Preview"
              class="img-fluid rounded-3"
            />
            <div class="image-actions d-flex gap-2 mt-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-primary flex-fill"
                (click)="fileInput?.click(); $event.stopPropagation()"
              >
                Cambia immagine
              </button>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger flex-fill"
                (click)="removeImage(); $event.stopPropagation()"
              >
                Rimuovi
              </button>
            </div>
          </div>
          }
          <input
            type="file"
            id="fileInput"
            #fileInput
            class="d-none"
            accept="image/*"
            (change)="onFileSelected($event)"
          />
        </div>
      </div>
    </section>
  </section>

  @if(selectedQuestionType() === 'scelta multipla') {
  <section class="row form-section">
    <div class="col-8">
      <app-multiple-choice-options
        [options]="questionOptions"
        (optionsChange)="onOptionsChange($event)"
      ></app-multiple-choice-options>
    </div>
  </section>
  }

  <section class="form-section">
    <label class="form-label fw-semibold text-dark"
      >Spiegazione della risposta corretta</label
    >
    <textarea
      class="form-control custom-input flex-fill"
      formControlName="explanation"
      rows="4"
      placeholder="Inserisci una commento sulla risposta corretta..."
    ></textarea>
  </section>

  <section class="form-section">
    <label class="form-label fw-semibold text-dark"
      >Visibilità della domanda e politiche di utilizzo</label
    >
    <p>
      Scegli se permettere ai tuoi studenti di Scienze Nautiche di utilizzare
      questa domanda per creare dei test di autovalutazione
    </p>

    <section class="row">
      <div class="col-3">
        <div
          class="card shadow-sm typeCard p-1"
          (click)="onSelectPolicyType('public')"
          [class.selected]="selectedPolicyType() === 'public'"
        >
          <div class="card-body d-flex flex-row align-items-center gap-3">
            <input
              type="radio"
              class="form-check-input"
              [checked]="selectedPolicyType() === 'public'"
            />
            <h5 class="mb-0 flex-fill">Disponibile agli studenti</h5>
            <span class="typeIconWrapper rounded-2">
              <fa-icon [icon]="UsersIcon" [size]="'2x'"></fa-icon>
            </span>
          </div>
        </div>
      </div>
      <div class="col-3">
        <div
          class="card shadow-sm typeCard p-1"
          (click)="onSelectPolicyType('private')"
          [class.selected]="selectedPolicyType() === 'private'"
        >
          <div class="card-body d-flex flex-row align-items-center gap-3">
            <input
              type="radio"
              class="form-check-input"
              [checked]="selectedPolicyType() === 'private'"
            />
            <h5 class="mb-0 flex-fill">Disponibile solo al docente</h5>
            <span class="typeIconWrapper rounded-2">
              <fa-icon [icon]="GraduationIcon" [size]="'2x'"></fa-icon>
            </span>
          </div>
        </div>
      </div>
    </section>
  </section>

  <section class="d-flex flex-row justify-content-end mt-5 gap-3">
    <button
      class="btn btn-success text-white btn-lg fs-3"
      type="submit"
      [disabled]="questionForm.invalid || loading()"
    >
      <fa-icon
        [icon]="loading() ? SpinnerIcon : SaveIcon"
        [animation]="loading() ? 'spin' : undefined"
      ></fa-icon>
      Salva
    </button>
  </section>
</form>
