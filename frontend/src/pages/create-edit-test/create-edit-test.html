<app-back-to
  [path]="'/t/tests'"
  [label]="'Torna alla lista dei test'"
></app-back-to>

<h1 class="text-dark fw-medium mb-3 display-6">{{ PageTitle() }}</h1>
<h5 class="text-dark mb-5 fw-normal">
  Prepara il prossimo test per le tue classi
</h5>

@if (IsLoading()) {
<div class="d-flex justify-content-center align-items-center py-5">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Caricamento...</span>
  </div>
</div>
} @else {
<form [formGroup]="TestForm" class="d-flex flex-column gap-4 pb-5">
  <section class="form-section">
    <label for="test-title" class="form-label text-dark">Titolo del test</label>
    <input
      type="text"
      id="test-title"
      class="form-control custom-input form-control-lg"
      formControlName="title"
      placeholder="Inserisci il titolo del test"
    />
  </section>
  <section class="form-section">
    <label class="form-label fw-light text-dark"
      >Disponibilità agli studenti</label
    >
    <div class="row">
      <div class="col-6">
        <div class="row">
          <div class="col-6">
            <label for="available-from" class="form-label text-dark"
              >Dal giorno</label
            >
            <input
              type="date"
              formControlName="availableFrom"
              id="available-from"
              class="form-control custom-input"
            />
          </div>
          <div class="col-6">
            <label for="available-to" class="form-label text-dark"
              >Fino al giorno</label
            >
            <input
              type="date"
              formControlName="availableTo"
              id="available-to"
              class="form-control custom-input"
            />
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="form-section">
    <label class="form-label fw-light text-dark"
      >Assegnazione e politiche di accesso al test</label
    >
    <div class="row">
      <div class="col-6">
        <label class="form-label text-dark"
          >Classi a cui assegnare il test</label
        >
        <app-class-selector
          [selectedClassIds]="assignedClasses"
          (selectedClassIdsChange)="onClassesChange($event)"
        ></app-class-selector>
      </div>
      <div class="col-6">
        <label for="access-password" class="form-label text-dark"
          >Password d'accesso</label
        >
        <div class="d-flex flex-row gap-3">
          <input
            type="text"
            id="access-password"
            class="form-control custom-input"
            formControlName="password"
            placeholder="Imposta una password per il test (opzionale)"
          />
          <button class="btn btn-primary" (click)="onGeneratePassword()">
            <fa-icon [icon]="GenPasswordIcon"></fa-icon>
          </button>
        </div>
      </div>
    </div>
  </section>

  <section class="form-section">
    <div
      class="d-flex flex-row justify-content-between align-items-center mb-4"
    >
      <div>
        <label class="form-label text-dark mb-0">Domande</label>
        <p class="text-dark fw-light">
          Cerca nella tua banca domande di
          <span class="fw-bold"
            >{{ materiaService.materiaSelected()!.name }}</span
          >
          e sceglile per comporre il test
        </p>
      </div>
      <button
        class="btn btn-lg ai"
        type="button"
        (click)="onRequestAIGeneration()"
      >
        <fa-icon [icon]="SparklesIcon" class="me-2"></fa-icon>
        Genera con AI
      </button>
    </div>

    <app-questions-search-filters
      (filtersChanged)="questionsSearched.onFiltersChanged($event)"
    ></app-questions-search-filters>
    <div class="row mt-5">
      <div class="col-6">
        <app-search-questions #questionsSearched></app-search-questions>
      </div>
      <div class="col-6">
        <app-questions-droppable-list
          [questionsToLoad]="QuestionsToLoad()"
        ></app-questions-droppable-list>
      </div>
    </div>
  </section>

  <section class="form-section">
    <label class="form-label fw-light text-dark"
      >Requisiti per superare il test e tempo a disposizione</label
    >
    <div class="row">
      <div class="col-4">
        <label for="required-score" class="form-label text-dark"
          >Punteggio minimo per idoneità</label
        >
        <input
          type="number"
          min="1"
          [max]="maxScore || 100"
          id="required-score"
          class="form-control custom-input"
          formControlName="requiredScore"
          [placeholder]="maxScore > 0 ? 'Max: ' + maxScore + ' punti' : 'Imposta il punteggio minimo per superare il test'"
        />
        @if (maxScore > 0) {
        <small class="text-muted"
          >Punteggio massimo del test: {{ maxScore }} punti</small
        >
        }
      </div>
      <div class="col-4">
        <label for="max-time" class="form-label text-dark"
          >Tempo massimo (minuti)</label
        >
        <div class="d-flex flex-row gap-3">
          <input
            type="number"
            min="0"
            max="100"
            id="max-time"
            class="form-control custom-input"
            formControlName="time"
            [placeholder]="time === null ? 'Tempo illimitato' : 'Imposta il tempo massimo per il test'"
          />
          <button
            class="btn"
            id="infiniteButton"
            [class.selected]="time === null"
            (click)="onToggleUnlimitedTime()"
          >
            <fa-icon [icon]="InfinityIcon"></fa-icon>
          </button>
        </div>
      </div>
    </div>
  </section>

  <div class="d-flex flex-row justify-content-end mt-5 gap-3">
    <button
      class="btn btn-link btn-lg"
      type="button"
      (click)="onSaveTest(true)"
      [disabled]="IsLoading() || !CanSaveDraft()"
    >
      Salva Bozza
    </button>
    <button
      class="btn btn-gradient-primary icon-btn btn-lg"
      type="button"
      (click)="onSaveTest()"
      [disabled]="IsLoading() || !CanPublish()"
    >
      Salva
    </button>
  </div>
</form>
}
