<h1 class="text-dark fw-medium mb-3 display-6">File e Risorse</h1>
<h5 class="text-dark mb-0 fw-normal">
  Gestisci e visualizza i tuoi file e le risorse per la materia selezionata.
</h5>

<section class="d-flex flex-row gap-3 my-5">
  <input
    #fileInput
    type="file"
    class="d-none"
    (change)="onFileSelected($event)"
    [accept]="'.pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.gif,.txt'"
  />
  <div>
    <input
      type="text"
      class="form-control me-3 custom-input filter"
      id="search-term"
      placeholder="Cerca file o cartella..."
      style="min-width: 400px"
      [(ngModel)]="searchTerm"
    />
  </div>
  <button
    type="button"
    class="btn btn-outline-danger"
    (click)="clearFilters()"
    title="Pulisci filtri"
  >
    <fa-icon [icon]="ClearIcon"></fa-icon>
  </button>

  <app-view-type-toggle
    class="ms-auto"
    [viewType]="viewType()"
    [pageKey]="'materiali'"
    (viewTypeChange)="onChangeViewType($event)"
  />
</section>

<section class="form-section">
  <div class="d-flex flex-row align-items-center justify-content-between mb-4">
    <div class="d-flex flex-row align-items-center gap-2">
      @for(dir of currentPathArray(); track $index; let last = $last){
      <a
        (click)="onRequestOpenItem(dir)"
        class="breadcrumb-link"
        (dragover)="onDragOver($event)"
        (drop)="onDrop(dir, $event)"
        (dragenter)="onDragEnter($event)"
        (dragleave)="onDragLeave($event)"
      >
        <span [class.fw-bold]="last">{{ dir }}</span>
      </a>
      @if(!last){
      <fa-icon [icon]="chevronRightIcon" class="text-muted"></fa-icon>
      } }
    </div>
    <div class="d-flex flex-row align-items-center gap-3">
      <button
        class="btn btn-outline-primary icon-btn"
        (click)="onCreateNewFolder()"
      >
        <fa-icon [icon]="plusIcon"></fa-icon> Nuova cartella
      </button>
      <button
        class="btn btn-outline-primary icon-btn"
        (click)="onRequestUpload()"
      >
        <fa-icon [icon]="uploadIcon"></fa-icon> Carica file
      </button>
      <button class="btn ai icon-btn" (click)="onRequestGenerate()">
        <fa-icon [icon]="sparklesIcon"></fa-icon> Genera con AI
      </button>
    </div>
  </div>

  @if(viewType() === 'grid') {
  <div class="row">
    @for(item of rootFolder().content; track item._id){
    <div class="col-12 col-md-6 col-lg-4 col-xl-3 mb-3">
      @if('content' in item) {
      <div
        (dragover)="onDragOver($event)"
        (drop)="onDrop(item, $event)"
        (dragenter)="onDragEnter($event)"
        (dragleave)="onDragLeave($event)"
      >
        <app-materiale-card
          [item]="item"
          [highlightedItemId]="highlightedItemId()"
          [isSelected]="isItemSelected(item._id)"
          [draggable]="true"
          (openItem)="onRequestOpenItem(item)"
          (dragstart)="onDragStart(item, $event)"
          (renameItem)="onRequestRenameItem(item, $event)"
          (deleteItem)="onRequestDeleteItem(item)"
          (selectItemEvent)="onSelectItem(item, $event)"
        />
      </div>
      } @else {
      <app-materiale-card
        [item]="item"
        [highlightedItemId]="highlightedItemId()"
        [isSelected]="isItemSelected(item._id)"
        [draggable]="true"
        (openItem)="onRequestOpenItem(item)"
        (dragstart)="onDragStart(item, $event)"
        (renameItem)="onRequestRenameItem(item, $event)"
        (deleteItem)="onRequestDeleteItem(item)"
        (selectItemEvent)="onSelectItem(item, $event)"
      />
      }
    </div>
    } @empty {
    <div class="col-12 text-center py-5">
      <p class="text-muted">Nessun elemento presente</p>
    </div>
    }
  </div>
  } @else {
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th style="width: 40px"></th>
          <th>Nome</th>
          <th style="width: 120px">Tipo</th>
          <th style="width: 120px">Dimensione</th>
          <th style="width: 180px">Data modifica</th>
          <th style="width: 50px"></th>
        </tr>
      </thead>
      <tbody>
        @for(item of rootFolder().content; track item._id){
        <tr
          class="cursor-pointer"
          [class.table-active]="isItemSelected(item._id)"
          [class.highlight-row]="highlightedItemId() === item._id"
          [draggable]="true"
          (click)="onSelectItem(item, $event)"
          (dblclick)="onRequestOpenItem(item); $event.stopPropagation()"
          (dragstart)="onDragStart(item, $event)"
          (dragover)="onDragOver($event)"
          (drop)="onDrop(item, $event)"
          (dragenter)="onDragEnter($event)"
          (dragleave)="onDragLeave($event)"
        >
          <td>
            @if (isAIGenerated(item)) {
            <fa-icon
              [icon]="robotIcon"
              class="me-3"
              style="color: #9664c8"
              size="lg"
            />
            } @else {
            <fa-icon
              [icon]="getItemIcon(item)"
              size="lg"
              [style.color]="getItemColor(item)"
            />
            }
          </td>
          <td class="">{{ item.name }}</td>
          <td class="text-muted">{{ getItemType(item) }}</td>
          <td class="text-muted">{{ getItemSize(item) }}</td>
          <td class="text-muted">
            {{ item.createdAt | date: 'dd/MM/yyyy HH:mm' }}
          </td>
          <td>
            <div ngbDropdown class="d-inline-block">
              <button
                class="btn btn-sm btn-light circle-btn"
                (click)="$event.stopPropagation()"
                ngbDropdownToggle
              >
                <fa-icon [icon]="threeDotsIcon" />
              </button>
              <div ngbDropdownMenu>
                <app-materiale-contextual-menu
                  [item]="item"
                  (renameItem)="onRequestRenameItem(item, $event)"
                  (deleteItem)="onRequestDeleteItem(item)"
                />
              </div>
            </div>
          </td>
        </tr>
        } @empty {
        <tr>
          <td colspan="6" class="text-center py-5">
            <p class="text-muted">Nessun elemento presente</p>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  }
</section>
