<app-back-to [path]="'/s/tests'" [label]="'Torna ai test'" />

@if (IsLoading()) {
<div class="d-flex justify-content-center align-items-center py-5">
  <fa-icon
    [icon]="SpinnerIcon"
    [animation]="'spin'"
    [size]="'3x'"
    class="text-primary"
  ></fa-icon>
</div>
} @else if (Error()) {
<div class="alert alert-danger" role="alert">{{ Error() }}</div>
} @else if (TestData() && !TestStarted()) {
<!-- Pre-start screen -->
<div class="d-flex flex-column align-items-center justify-content-center py-5">
  <div class="card p-5 text-center pre-start-card">
    <h2 class="text-dark fw-medium mb-3">
      @if (IsResuming()) { Hai un tentativo in corso per } @else { Stai per
      svolgere il test }
    </h2>
    <h1 class="display-5 fw-bold text-primary mb-4">{{ TestData()!.name }}</h1>

    <p class="text-muted mb-2">
      {{ Questions().length }} domande @if (HasTimeLimit()) { &middot; Tempo
      limite: {{ TestData()!.timeLimit }} minuti }
    </p>

    @if (HasDeadline()) {
    <div
      class="alert alert-info d-inline-flex align-items-center gap-2 mt-2 mb-4"
    >
      <fa-icon [icon]="ClockIcon"></fa-icon>
      <span>
        Questo test va consegnato entro il {{ DeadlineDate() | date: 'd MMMM y,
        HH:mm' }}
      </span>
    </div>
    }

    <div class="d-flex flex-row gap-3 justify-content-center mt-3">
      <button
        class="btn btn-outline-secondary btn-lg px-4"
        (click)="onGoBack()"
      >
        <fa-icon [icon]="BackIcon" class="me-2"></fa-icon>
        Torna alla lista
      </button>
      @if (IsResuming()) {
      <button
        class="btn btn-warning btn-lg px-5 text-white"
        (click)="onStartTest()"
      >
        <fa-icon [icon]="ResumeIcon" class="me-2"></fa-icon>
        Riprendi test
      </button>
      } @else {
      <button class="btn btn-primary btn-lg px-5" (click)="onStartTest()">
        <fa-icon [icon]="PlayIcon" class="me-2"></fa-icon>
        Avvia test
      </button>
      }
    </div>
  </div>
</div>
} @else if (TestData() && TestStarted()) {
<!-- Header -->
<div class="d-flex flex-row justify-content-between align-items-start mb-4">
  <div>
    <h1 class="text-dark fw-medium mb-2 display-6">{{ TestData()!.name }}</h1>
    <p class="text-muted mb-0">
      {{ Questions().length }} domande &middot; {{ AnsweredCount() }} risposte
    </p>
  </div>
  @if (HasTimeLimit()) {
  <div
    class="timer-badge d-flex align-items-center gap-2 px-4 py-2 rounded-pill fs-4 fw-semibold"
    [class.timer-danger]="RemainingSeconds() <= 60 && !TimerExpired()"
    [class.timer-expired]="TimerExpired()"
  >
    <fa-icon [icon]="ClockIcon"></fa-icon>
    {{ FormattedTime() }}
  </div>
  }
</div>

@if (TimerExpired()) {
<div
  class="alert alert-warning d-flex align-items-center gap-2 mb-4"
  role="alert"
>
  <fa-icon [icon]="ClockIcon"></fa-icon>
  <span
    >Tempo scaduto! Non puoi pi√π modificare le risposte. Consegna il test.</span
  >
</div>
}

<!-- Questions -->
<div class="d-flex flex-column gap-3 mb-4">
  @for (question of Questions(); track question._id; let i = $index) {
  <div
    app-question-card
    [question]="question"
    [index]="i"
    [showIndex]="true"
    [studentMode]="true"
    [locked]="TimerExpired()"
    [dimmed]="TimerExpired()"
    [selectedAnswer]="Answers()[question._id] ?? null"
    (answerChange)="onAnswerChange(question._id, $event)"
  ></div>
  }
</div>

<!-- Submit -->
<div class="d-flex justify-content-end mb-5">
  <button
    class="btn btn-primary btn-lg px-5"
    [disabled]="IsSubmitting()"
    (click)="onSubmit()"
  >
    @if (IsSubmitting()) {
    <fa-icon [icon]="SpinnerIcon" [animation]="'spin'" class="me-2"></fa-icon>
    } Consegna test
  </button>
</div>
}
