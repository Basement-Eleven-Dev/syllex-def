<div class="card p-3 h-100">
  <div class="card-body d-flex flex-column">
    <div class="flex-fill position-relative">
      <div
        #scrollContent
        class="h-100 overflow-scroll position-absolute top-0 start-0 end-0"
      >
        @for (msg of messages(); track $index) {
        <div
          class="d-flex mb-3"
          [class.justify-content-end]="msg.role === 'user'"
        >
          <div
            class="d-flex flex-column"
            [class.align-items-end]="msg.role === 'user'"
          >
            <div class="d-flex align-items-center gap-2">
              <div
                class="message-bubble py-3 px-3"
                style="border-radius: 8px"
                [class.user-message]="msg.role === 'user'"
                [class.agent-message]="msg.role === 'agent'"
              >
                @if (msg.role === 'agent') {
                <markdown [data]="msg.content"></markdown>
                } @else {
                <span>{{ msg.content }}</span>
                }
              </div>

              @if (msg.role === 'agent') {
              <button
                class="btn btn-outline-primary rounded-circle p-0 d-flex align-items-center justify-content-center btn-listen"
                style="width: 28px; height: 28px; min-width: 28px"
                title="Ascolta audio"
                (click)="listenMessage(msg)"
                [disabled]="loadingAudioIds().has(msg._id!)"
              >
                @if (loadingAudioIds().has(msg._id!)) {
                <fa-icon
                  [icon]="faSpinner"
                  [animation]="'spin'"
                  style="font-size: 0.8rem"
                />
                } @else {
                <fa-icon
                  [icon]="currentPlayingId() === msg._id ? audioPause : (msg.audioUrl ? audioPlay : faHeadphones)"
                  style="font-size: 0.8rem"
                />
                }
              </button>
              }
            </div>

            <span class="text-primary mt-1" style="font-size: 0.75rem">
              {{ msg.timestamp | date : 'HH:mm' }}
            </span>
          </div>
        </div>
        } @empty {
        <div
          class="h-100 d-flex flex-column align-items-center justify-content-center text-center p-4 animate-fade-in"
        >
          <div class="bg-primary bg-opacity-10 p-4 rounded-circle mb-4">
            <fa-icon
              [icon]="faSparkles"
              size="3x"
              class="text-primary opacity-75"
            ></fa-icon>
          </div>
          <h4 class="fw-bold text-dark mb-2">
            Sono il tuo Assistente Didattico
          </h4>
          <p class="text-muted mb-5 max-w-300">
            Posso aiutarti a comprendere meglio i materiali di studio. Iniziamo?
          </p>

          <div class="row g-3 w-100 max-w-500">
            <div class="col-12 col-md-6">
              <button
                (click)="setAndSendMessage('Quali sono gli argomenti principali di questa materia?')"
                class="btn btn-light w-100 text-start p-3 border h-100 rounded-4 transition-all hover-lift"
              >
                <fa-icon
                  [icon]="faBookOpen"
                  class="text-primary me-2"
                ></fa-icon>
                <span class="small fw-semibold">Argomenti principali</span>
              </button>
            </div>
            <div class="col-12 col-md-6">
              <button
                (click)="setAndSendMessage('Puoi farmi un riassunto sintetico della dispensa?')"
                class="btn btn-light w-100 text-start p-3 border h-100 rounded-4 transition-all hover-lift"
              >
                <fa-icon
                  [icon]="faLightbulb"
                  class="text-warning me-2"
                ></fa-icon>
                <span class="small fw-semibold">Riassunto sintetico</span>
              </button>
            </div>
            <div class="col-12">
              <button
                (click)="setAndSendMessage('Preparami 3 domande veloci per vedere se ho capito i concetti chiave.')"
                class="btn btn-light w-100 text-start p-3 border h-100 rounded-4 transition-all hover-lift"
              >
                <fa-icon
                  [icon]="faQuestionCircle"
                  class="text-success me-2"
                ></fa-icon>
                <span class="small fw-semibold"
                  >Mettimi alla prova con 3 domande</span
                >
              </button>
            </div>
          </div>
        </div>
        } @if (isLoading()) {
        <div class="d-flex mb-3">
          <div class="message-bubble agent-message p-3 rounded-3">
            <div class="typing-indicator d-flex gap-1">
              <span></span><span></span><span></span>
            </div>
          </div>
        </div>
        }
      </div>
    </div>

    <div class="pt-3 border-top">
      <div class="input-group">
        <textarea
          class="form-control custom-input"
          [(ngModel)]="inputMessage"
          (keydown)="onKeydown($event)"
          placeholder="Scrivi un messaggio..."
          rows="1"
        ></textarea>
        <button
          class="btn btn-primary"
          type="button"
          (click)="sendMessage()"
          [disabled]="!inputMessage.trim() || isLoading()"
        >
          <fa-icon [icon]="SendIcon"></fa-icon>
        </button>
      </div>
    </div>
  </div>
</div>
