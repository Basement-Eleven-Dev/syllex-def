@if (isLoading()) {
<div class="d-flex justify-content-center align-items-center py-5">
  <fa-icon
    [icon]="SpinnerIcon"
    [animation]="'spin'"
    size="3x"
    class="text-primary"
  ></fa-icon>
</div>
} @else if (data(); as d) {
<app-back-to [path]="backUrl" [label]="'Vai alle correzioni'" />
<div class="d-flex flex-row align-items-center mb-5">
  <div class="flex-fill">
    <h1 class="text-dark fw-bold mb-0 display-6">
      <fa-icon [icon]="UserIcon" class="me-2 fixed-width"></fa-icon>{{
      d.studentName }}
    </h1>
    <div class="d-flex flex-column gap-2 mt-3">
      <span class="text-dark mb-0"> Test: {{ d.testTitle }} </span>
      <span class="text-dark mb-0">
        <fa-icon [icon]="ClockIcon" class="me-2"></fa-icon>
        {{ d.submissionDate | date:'short' }}
      </span>
    </div>
  </div>
  <span
    class="badge fs-5 p-3 rounded-pill"
    id="statusBadge"
    [class.da-correggere]="d.status === 'delivered'"
    [class.corretto]="d.status === 'reviewed'"
  >
    {{ (d.status === 'delivered' ? 'da correggere' : 'corretto') | titlecase }}
  </span>
</div>

<div class="row">
  <!-- Punteggio -->
  <div class="col-12 col-md-6 col-lg-3 mb-3">
    <div class="card h-100">
      <div class="card-body d-flex flex-column align-items-center p-4">
        <span class="card-value text-dark">
          {{ d.score != null ? d.score : '?' }}<span class="reduced">/{{ d.maxScore }}</span>
        </span>
        <p class="mb-0 card-description text-dark">Punteggio</p>
      </div>
    </div>
  </div>

  <!-- Risposte -->
  <div class="col-12 col-md-6 col-lg-6 mb-3">
    <div class="card h-100">
      <div class="card-body d-flex flex-column align-items-center p-4">
        <div class="d-flex flex-row justify-content-around align-items-center w-100 flex-fill">
          <span class="card-value text-success">
            {{ d.questionsStats.correct }}
            <fa-icon [icon]="CheckIcon" size="xs"></fa-icon>
          </span>
          <span class="card-value text-danger">
            {{ d.questionsStats.wrong }}
            <fa-icon [icon]="TimesIcon" size="xs"></fa-icon>
          </span>
          <span class="card-value text-warning">
            {{ d.questionsStats.dubious }}
            <fa-icon [icon]="QuestionMarkIcon" size="xs"></fa-icon>
          </span>
          <span class="card-value" style="color: rgb(166, 166, 166)">
            {{ d.questionsStats.empty }}
            <fa-icon [icon]="CircleIcon" size="xs"></fa-icon>
          </span>
        </div>
        <p class="mb-0 card-description text-dark">Riepilogo risposte</p>
      </div>
    </div>
  </div>

  <!-- Tempo Impiegato -->
  <div class="col-12 col-md-6 col-lg-3 mb-3">
    <div class="card h-100">
      <div class="card-body d-flex flex-column align-items-center p-4">
        <span class="card-value text-dark">
          {{ d.timeSpent * 1000 | date: 'mm:ss' }}
        </span>
        <p class="mb-0 card-description text-dark">
          Tempo impiegato <br>
          <small style="font-size: 0.7em">(max: {{ d.maxTime }}min)</small>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Confronto classe e Insight IA -->
<div class="row mt-4">
  <div class="col-12 col-lg-8">
    <div class="card border-0 rounded-4 shadow-sm h-100">
      <div class="card-body p-4">
        <h6 class="fw-bold text-dark mb-3">
          {{ (d.studentTopicPerformance.length === 1 && d.studentTopicPerformance[0].name === 'Generale') ? 'Padronanza Totale' : 'Padronanza per Argomento' }}
        </h6>
        <div style="height: 200px">
          <app-student-performance-chart 
            [data]="d.studentTopicPerformance" 
            [compareData]="d.classTopicPerformance" 
            type="doughnut" 
          />
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-4 mt-4 mt-lg-0">
    <div class="card bg-primary bg-opacity-10 border-0 rounded-4 shadow-sm h-100">
      <div class="card-body p-4 d-flex flex-column justify-content-center">
        <div class="d-flex align-items-center mb-3">
          <fa-icon [icon]="ClockIcon" class="text-primary me-2"></fa-icon>
          <div>
            <div class="text-muted small lh-1">Tempo impiegato</div>
            <div class="fw-bold text-primary">{{ d.timeSpent }}s <span class="text-muted fw-normal small">/ media: {{ d.classAverageTime }}s</span></div>
          </div>
        </div>
        <div class="d-flex align-items-center">
          <fa-icon [icon]="CheckIcon" class="text-primary me-2"></fa-icon>
          <div>
            <div class="text-muted small lh-1">Media Punteggio Classe</div>
            <div class="fw-bold text-primary">{{ d.classAverageScore }} / {{ d.maxScore }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div style="margin-top: 5rem;">
  <app-test-ai-summary [id]="attemptId()!" mode="attempt" [initialValue]="d.aiInsight" />
</div>

<section class="form-section mt-5">
  <div class="d-flex justify-content-between align-items-end mb-4">
    <div>
      <label class="form-label text-dark fw-bold fs-3">
        {{ d.status === 'reviewed' ? 'Correzione' : 'Precorrezione AI' }}
      </label>
      <p class="text-dark mb-0">
        L'AI ha gi√† analizzato il compito. Revisiona le domande e conferma la
        correzione finale.
      </p>
    </div>
    @if(d.status != 'reviewed') {
    <button
      class="btn btn-primary btn-lg"
      (click)="submitCorrection()"
      [disabled]="isSaving() || !allQuestionsAreScored"
    >
      @if (isSaving()) {
      <fa-icon [icon]="SpinnerIcon" [animation]="'spin'" class="me-2"></fa-icon>
      } @else {
      <fa-icon [icon]="CheckIcon" class="me-2"></fa-icon>
      } Finalizza Correzione</button
    >}
  </div>
  <div class="d-flex flex-row align-items-center gap-2 flex-wrap mb-5">
    @for(q of d.questions; track $index) {
    <button
      class="btn btn-light btnSelectQuestion"
      [class.correct]="q?.answer?.result === 'correct'"
      [class.wrong]="q?.answer?.result === 'wrong'"
      [class.open]="q?.answer?.result === 'dubious'"
      [class.empty]="q?.answer?.result === 'empty'"
      [class.selected]="questionIndex() === $index"
      (click)="selectQuestion($index)"
    >
      {{ $index + 1 }}
    </button>
    }
  </div>
  @if (attemptId(); as id) { @if (d.questions[questionIndex()]) {
  <app-question-correction
    [index]="questionIndex() + 1"
    [data]="d.questions[questionIndex()]"
    [isReviewed]="d.status === 'reviewed'"
    [attemptId]="id"
  />
  } }
</section>

} @else {
<div class="alert alert-warning">Impossibile caricare i dati del test.</div>
}
